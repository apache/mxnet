I"÷2<!--- Licensed to the Apache Software Foundation (ASF) under one -->
<!--- or more contributor license agreements.  See the NOTICE file -->
<!--- distributed with this work for additional information -->
<!--- regarding copyright ownership.  The ASF licenses this file -->
<!--- to you under the Apache License, Version 2.0 (the -->
<!--- "License"); you may not use this file except in compliance -->
<!--- with the License.  You may obtain a copy of the License at -->

<!---   http://www.apache.org/licenses/LICENSE-2.0 -->

<!--- Unless required by applicable law or agreed to in writing, -->
<!--- software distributed under the License is distributed on an -->
<!--- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY -->
<!--- KIND, either express or implied.  See the License for the -->
<!--- specific language governing permissions and limitations -->
<!--- under the License. -->

<h1 id="mxnet-scala-data-loading-api">MXNet Scala Data Loading API</h1>
<p>This topic introduces the data input method for MXNet. MXNet uses an iterator to provide data to the neural network.  Iterators do some preprocessing and generate batches for the neural network.</p>

<p>MXNet provides basic iterators for MNIST and RecordIO images. To hide the cost of I/O, MXNet uses a prefetch strategy that enables parallelism for the learning process and data fetching. Data is automatically fetched by an independent thread.</p>

<p>Topics:</p>

<ul>
  <li><a href="#parameters-for-data-iterator">Data Iterator Parameters</a> clarifies the different usages for dataiter parameters.</li>
  <li><a href="#create-a-data-iterator">Create a Data Iterator</a> introduces how to create a data iterator in MXNet for Scala.</li>
  <li><a href="#how-to-get-data">How to Get Data</a> introduces the data resource and data preparation tools.</li>
  <li><a href="/api/scala/docs/api/#org.apache.mxnet.io.package">IO API Reference</a> explains the IO API.</li>
</ul>

<h2 id="data-iterator-parameters">Data Iterator Parameters</h2>

<p>To create a data iterator, you typically need to provide five parameters:</p>

<ul>
  <li><strong>Dataset Param</strong> provides basic information about the dataset, e.g., file path, input shape.</li>
  <li><strong>Batch Param</strong> provides information required to form a batch, e.g., batch size.</li>
  <li><strong>Augmentation Param</strong> tells MXNet which augmentation operations (e.g., crop or mirror) to perform on an input image.</li>
  <li><strong>Backend Param</strong> controls the behavior of the back-end threads to hide the cost of data loading.</li>
  <li><strong>Auxiliary Param</strong> provides options for checking and debugging.</li>
</ul>

<p>You <em>must</em> provide the <strong>Dataset Param</strong> and <strong>Batch Param</strong>, otherwise MXNet can‚Äôt create the data batch. Provide other parameters as required by your algorithm and performance needs. We provide a detailed explanation and examples of the options later.</p>

<h2 id="create-a-data-iterator">Create a Data Iterator</h2>

<p>The IO API provides a simple way to create a data iterator in Scala.
The following example code shows how to create a CIFAR data iterator.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">dataiter</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">ImageRecordIter</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span>
    <span class="c1">// Utility Parameter</span>
    <span class="c1">// Optional</span>
    <span class="c1">// Name of the data, should match the name of the data input of the network</span>
    <span class="c1">// data_name='data',</span>
    <span class="c1">// Utility Parameter</span>
    <span class="c1">// Optional</span>
    <span class="c1">// Name of the label, should match the name of the label parameter of the network</span>
    <span class="c1">// Usually, if the loss layer is named 'foo', then the label input has the name</span>
    <span class="c1">// 'foo_label', unless overwritten</span>
    <span class="c1">// label_name='softmax_label',</span>
    <span class="c1">// Dataset Parameter</span>
    <span class="c1">// Impulsary</span>
    <span class="c1">// indicating the data file, please check the data is already there</span>
    <span class="s">"path_imgrec"</span> <span class="o">-&gt;</span> <span class="s">"data/cifar/train.rec"</span><span class="o">,</span>
    <span class="c1">// Dataset Parameter</span>
    <span class="c1">// Impulsary</span>
    <span class="c1">// indicating the image size after preprocessing</span>
    <span class="s">"data_shape"</span> <span class="o">-&gt;</span> <span class="s">"(3,28,28)"</span><span class="o">,</span>
    <span class="c1">// Batch Parameter</span>
    <span class="c1">// Impulsary</span>
    <span class="c1">// tells how many images in a batch</span>
    <span class="s">"batch_size"</span> <span class="o">-&gt;</span> <span class="s">"100"</span><span class="o">,</span>
    <span class="c1">// Augmentation Parameter</span>
    <span class="c1">// Optional</span>
    <span class="c1">// when offers mean_img, each image will subtract the mean value at each pixel</span>
    <span class="s">"mean_img"</span> <span class="o">-&gt;</span> <span class="s">"data/cifar/cifar10_mean.bin"</span><span class="o">,</span>
    <span class="c1">// Augmentation Parameter</span>
    <span class="c1">// Optional</span>
    <span class="c1">// randomly crop a patch of the data_shape from the original image</span>
   <span class="s">"rand_crop"</span> <span class="o">-&gt;</span> <span class="s">"True"</span><span class="o">,</span>
    <span class="c1">// Augmentation Parameter</span>
    <span class="c1">// Optional</span>
    <span class="c1">// randomly mirror the image horizontally</span>
    <span class="s">"rand_mirror"</span> <span class="o">-&gt;</span> <span class="s">"True"</span><span class="o">,</span>
    <span class="c1">// Augmentation Parameter</span>
    <span class="c1">// Optional</span>
    <span class="c1">// randomly shuffle the data</span>
    <span class="s">"shuffle"</span> <span class="o">-&gt;</span> <span class="s">"False"</span><span class="o">,</span>
    <span class="c1">// Backend Parameter</span>
    <span class="c1">// Optional</span>
    <span class="c1">// Preprocessing thread number</span>
    <span class="s">"preprocess_threads"</span> <span class="o">-&gt;</span> <span class="s">"4"</span><span class="o">,</span>
    <span class="c1">// Backend Parameter</span>
    <span class="c1">// Optional</span>
    <span class="c1">// Prefetch buffer size</span>
    <span class="s">"prefetch_buffer"</span> <span class="k">=</span> <span class="s">"1"</span><span class="o">))</span>
</code></pre></div></div>

<p>First, explicitly specify the kind of data (MNIST, ImageRecord, etc.) to fetch. Then, provide the options for the dataset, batching, image augmentation, multi-tread processing,  and prefetching operations. The code automatically validates the parameters. If a required parameter is missing, MXNet returns an error.</p>

<h2 id="how-to-get-data">How to Get Data</h2>

<p>We provide <a href="https://github.com/apache/incubator-mxnet/tree/master/scala-package/core/scripts">scripts</a> to download MNIST data and CIFAR10 ImageRecord data. If you want to create your own dataset, we recommend using the Image RecordIO data format.</p>

<h2 id="create-a-dataset-using-recordio">Create a Dataset Using RecordIO</h2>

<p>RecordIO implements a file format for a sequence of records. We recommend storing images as records and packing them together. The benefits include:</p>

<ul>
  <li>Storing images in a compact format‚Äìe.g., JPEG, for records‚Äìgreatly reduces the size of the dataset on the disk.</li>
  <li>Packing data together allows continuous reading on the disk.</li>
  <li>RecordIO has a simple way to partition, simplifying distributed setting. We provide an example later.</li>
</ul>

<p>We provide the <a href="https://github.com/apache/incubator-mxnet/blob/master/tools/im2rec.cc">im2rec tool</a> so you can create an Image RecordIO dataset by yourself. The following walkthrough shows you how.</p>

<h3 id="prerequisites">Prerequisites</h3>
<p>Download the data. You don‚Äôt need to resize the images manually. You can use <code class="highlighter-rouge">im2rec</code> to resize them automatically. For details, see ‚ÄúExtension: Using Multiple Labels for a Single Image,‚Äù later in this topic.</p>

<h3 id="step-1-make-an-image-list-file">Step 1. Make an Image List File</h3>
<p>After you download the data, you need to make an image list file.  The format is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>integer_image_index \t label_index \t path_to_image
</code></pre></div></div>
<p>Typically, the program takes the list of names of all of the images, shuffles them, then separates them into two lists: a training filename list and a testing filename list. Write the list in the right format.</p>

<p>This is an example file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>95099  464     n04467665_17283.JPEG
10025081        412     ILSVRC2010_val_00025082.JPEG
74181   789     n01915811_2739.JPEG
10035553        859     ILSVRC2010_val_00035554.JPEG
10048727        929     ILSVRC2010_val_00048728.JPEG
94028   924     n01980166_4956.JPEG
1080682 650     n11807979_571.JPEG
972457  633     n07723039_1627.JPEG
7534    11      n01630670_4486.JPEG
1191261 249     n12407079_5106.JPEG
</code></pre></div></div>

<h3 id="step-2-create-the-binary-file">Step 2. Create the Binary File</h3>
<p>To generate a binary image, use <code class="highlighter-rouge">im2rec</code> in the tool folder. <code class="highlighter-rouge">im2rec</code> takes the path of the <code class="highlighter-rouge">_image list file_</code> you generated, the <code class="highlighter-rouge">_root path_</code> of the images, and the <code class="highlighter-rouge">_output file path_</code> as input. This process usually takes several hours, so be patient.</p>

<p>A sample command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/im2rec image.lst image_root_dir output.bin <span class="nv">resize</span><span class="o">=</span>256
</code></pre></div></div>
<p>For more details, run <code class="highlighter-rouge">./bin/im2rec</code>.</p>

<h3 id="extension-multiple-labels-for-a-single-image">Extension: Multiple Labels for a Single Image</h3>

<p>The <code class="highlighter-rouge">im2rec</code> tool and <code class="highlighter-rouge">IO.ImageRecordIter</code> have multi-label support for a single image.
For example, if you have four labels for a single image, you can use the following procedure to use the RecordIO tools.</p>

<ol>
  <li>Write the image list files as follows:</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> integer_image_index \t label_1 \t label_2 \t   label_3 \t label_4 \t path_to_image
</code></pre></div></div>

<ol>
  <li>Run <code class="highlighter-rouge">im2rec</code>, adding a ‚Äòlabel_width=4‚Äô to the command argument, for example:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ./bin/im2rec image.lst image_root_dir output.bin <span class="nv">resize</span><span class="o">=</span>256 <span class="nv">label_width</span><span class="o">=</span>4
</code></pre></div></div>

<ol>
  <li>In the iterator generation code, set <code class="highlighter-rouge">label_width=4</code> and <code class="highlighter-rouge">path_imglist=&lt;&lt;The PATH TO YOUR image.lst&gt;&gt;</code>, for example:</li>
</ol>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">dataiter</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">ImageRecordIter</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span>
    <span class="s">"path_imgrec"</span> <span class="o">-&gt;</span> <span class="s">"data/cifar/train.rec"</span><span class="o">,</span>
    <span class="s">"data_shape"</span> <span class="o">-&gt;</span> <span class="s">"(3,28,28)"</span><span class="o">,</span>
    <span class="s">"path_imglist"</span> <span class="o">-&gt;</span> <span class="s">"data/cifar/image.lst"</span><span class="o">,</span>
    <span class="s">"label_width"</span> <span class="o">-&gt;</span> <span class="s">"4"</span>
<span class="o">))</span>
</code></pre></div></div>

<h2 id="next-steps">Next Steps</h2>
<ul>
  <li><a href="ndarray">NDArray API</a> for vector/matrix/tensor operations</li>
  <li><a href="kvstore">KVStore API</a> for multi-GPU and multi-host distributed training</li>
</ul>
:ET